<div class="wrapper">
  <nav id="sidebar" class="sidebar js-sidebar">
    <div class="sidebar-content js-simplebar">
      <a class="sidebar-brand" href="/home">
        <img src="assets/images/logo_BDMS.png" class="align-middle" style="height: 30px;">
      </a>
              <ul class="sidebar-nav">
            <li class="sidebar-header">
                Pages
            </li>            
            <li class="sidebar-item">
                <a class="sidebar-link" href="home">
            <i class="align-middle" data-feather="sliders"></i> <span class="align-middle">Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/users">
                <i class="align-middle" data-feather="user"></i> <span class="align-middle">Liste des utilisateurs</span>
                </a>
            </li>
            <li class="sidebar-header">
                Administration
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/jourferie">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Jour Férié</span>
                </a>
            </li>
            <li class="sidebar-item ">
                <a class="sidebar-link" href="/typeteneur">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Type Teneur</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/compteteneur">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Compte Teneur</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/tmm">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">TMM</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/devises">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Devises</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/tauxcharge">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Taux Charges</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/typemarche">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Type Marche</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/commissionHE">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Commision HorsElec</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/commissionE">
                <i class="align-middle" data-feather="calendar"></i> <span class="align-middle">Commision Elec</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/categorieavoir">
                <i class="align-middle" data-feather="folder"></i> <span class="align-middle">Categorie d'Avoir</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="/groupes">
                <i class="align-middle" data-feather="folder"></i> <span class="align-middle">Groupes</span>
                </a>
            </li>
        </ul>
    </div>
  </nav>

  <div class="main">
    <nav class="navbar navbar-expand navbar-light navbar-bg">
      <a class="sidebar-toggle js-sidebar-toggle">
        <i class="hamburger align-self-center"></i>
      </a>

      <div class="navbar-collapse collapse">
        <ul class="navbar-nav navbar-align">
          <li class="nav-item dropdown">
            <a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown" aria-expanded="false" id="mobileDropdown">
              <i class="align-middle" data-feather="settings"></i>
            </a>
            <a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <!-- Image with fallback -->
              <img [src]="getUserImagePath() || '/assets/images/default-avatar.png'"
                   class="avatar img-fluid me-1"
                   style="width: 32px; height: 32px; object-fit: cover;"
                   onerror="this.onerror=null;this.src='/assets/images/default-avatar.png'">
              <span class="text-dark" *ngIf="user">
                {{ user.username || user.preferred_username || user.name || 'No username' }}
              </span>
            </a>
            <div class="dropdown-menu dropdown-menu-end">
              <a class="dropdown-item" href="/profile"><i class="align-middle me-1" data-feather="user"></i> Profile</a>
              <a class="dropdown-item" href="#" (click)="logout(); $event.preventDefault()">
                <i class="align-middle me-1" data-feather="log-out"></i> Log out
              </a>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <br><br><br>
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-8">
          <div class="card profile-card">
            <div class="card-header text-center">
              <h5 class="card-title mb-0">Profile Details</h5>
            </div>
            <div class="card-body text-center">
              <!-- User image circle -->
              <div class="user-image-container mb-4">
                <div class="user-image-circle mx-auto">
                  <img [src]="getUserImagePath() || '/assets/images/default-avatar.png'"
                       class="avatar img-fluid rounded-circle me-1"
                       style="width: 120px; height: 120px; object-fit: cover;"
                       onerror="this.onerror=null;this.src='/assets/images/default-avatar.png'">
                </div>
              </div>

              <!-- Add these near your form submit button -->
              <div *ngIf="isUpdating" class="text-center mt-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Updating profile...</span>
              </div>

              <div *ngIf="errorMessage" class="alert alert-danger mt-3">
                {{ errorMessage }}
              </div>

              <div *ngIf="successMessage" class="alert alert-success mt-3">
                {{ successMessage }}
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-outline-primary btn-custom-outline" (click)="openFaceModal()">
                  <i class="fas fa-user-circle me-2"></i>
                  {{ displayModalFaceUpdate ? 'Hide Face Login' : 'Update Face Login' }}
                </button>
              </div>
              
              <!-- Profile form -->
              <div class="profile-form-container">
                <!-- Profile form -->
                <div class="profile-form-container">
                  <form (ngSubmit)="updateUser()" class="text-start" #profileForm="ngForm">

                    <div class="mb-3">
                      <label for="preferred_username" class="form-label">Username <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="preferred_username"
                            [(ngModel)]="user.preferred_username" name="preferred_username" required disabled>
                    </div>

                    <div class="mb-3">
                      <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="firstName"
                            [(ngModel)]="user.firstName" name="firstName" required
                            minlength="2" maxlength="50" pattern="[a-zA-ZÀ-ÿ '-]*"
                            #firstName="ngModel">
                      <div *ngIf="firstName.invalid && (firstName.dirty || firstName.touched)" class="text-danger">
                        <div *ngIf="firstName.errors?.['required']">First name is required</div>
                        <div *ngIf="firstName.errors?.['minlength']">Minimum 2 characters</div>
                        <div *ngIf="firstName.errors?.['maxlength']">Maximum 50 characters</div>
                        <div *ngIf="firstName.errors?.['pattern']">Only letters, spaces, hyphens and apostrophes allowed</div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="lastName"
                            [(ngModel)]="user.lastName" name="lastName" required
                            minlength="2" maxlength="50" pattern="[a-zA-ZÀ-ÿ '-]*"
                            #lastName="ngModel">
                      <div *ngIf="lastName.invalid && (lastName.dirty || lastName.touched)" class="text-danger">
                        <div *ngIf="lastName.errors?.['required']">Last name is required</div>
                        <div *ngIf="lastName.errors?.['minlength']">Minimum 2 characters</div>
                        <div *ngIf="lastName.errors?.['maxlength']">Maximum 50 characters</div>
                        <div *ngIf="lastName.errors?.['pattern']">Only letters, spaces, hyphens and apostrophes allowed</div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="email" class="form-label">Email <span class="text-danger">*</span>:</label>
                      <input type="email" class="form-control" id="email"
                            [(ngModel)]="user.email" name="email" required disabled
                            #email="ngModel">
                      <div *ngIf="email.invalid && (email.dirty || email.touched)" class="text-danger">
                        <div *ngIf="email.errors?.['required']">Email is required</div>
                        <div *ngIf="email.errors?.['email']">Invalid email format</div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="image" class="form-label">Importer une image <span class="text-danger">*</span> </label>
                      <input type="file" class="form-control" id="image" accept="image/*" (change)="onFileSelectedAjout($event)">
                      <!-- Pas de validation pour l'image -->
                    </div>

                    <div class="mb-3">
                      <label for="adresse" class="form-label">Address <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="adresse"
                            [(ngModel)]="user.adresse" name="adresse"
                            maxlength="100"
                            #adresse="ngModel" required>
                      <div *ngIf="adresse.invalid && (adresse.dirty || adresse.touched)" class="text-danger">
                        <div *ngIf="adresse.errors?.['maxlength']">Maximum 100 characters</div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="phone" class="form-label">Phone <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="phone"
                             [(ngModel)]="user.phone" name="phone"
                             pattern="[0-9]*" maxlength="8"
                             #phone="ngModel" required>
                      <div *ngIf="phone.invalid && (phone.dirty || phone.touched)" class="text-danger">
                        <div *ngIf="phone.errors?.['pattern']">Only numbers allowed</div>
                        <div *ngIf="phone.errors?.['maxlength']">Maximum 8 digits</div>
                      </div>
                      <div *ngIf="errors?.phone" class="text-danger">{{ errors.phone }}</div>
                    </div>

                    <div class="text-center">
                      <button type="submit" class="btn btn-primary" [disabled]="profileForm.invalid || isUpdating">
                        <span *ngIf="!isUpdating">Update Profile</span>
                        <span *ngIf="isUpdating" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span *ngIf="isUpdating"> Updating...</span>
                      </button>
                    </div>
                  </form>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<p-dialog [(visible)]="displayModalFaceUpdate" [modal]="true" [style]="{width: '50vw'}" [draggable]="false" [resizable]="false" header="Face Recognition">
  <div class="card mb-4">

    <div class="card-body">
      <div class="face-capture-container text-center">
        <div class="camera-frame mb-3">
          <div class="camera-overlay">
            <div class="face-guide"></div>
          </div>
          <video #videoElement width="320" height="240" autoplay muted playsinline></video>
          <canvas #canvasElement width="320" height="240" class="d-none"></canvas>
          <img #photoElement class="preview-image d-none" alt="Your face">
        </div>
        <div class="camera-controls mb-3">
          <button type="button" class="btn btn-primary me-2" (click)="startCamera()">
            <i class="fas fa-video me-1"></i> Start Camera
          </button>
          <button type="button" class="btn btn-success me-2" (click)="captureFace()" [disabled]="!isCameraOn">
            <i class="fas fa-camera me-1"></i> Capture
          </button>
          <button type="button" class="btn btn-danger" (click)="stopCamera()" [disabled]="!isCameraOn">
            <i class="fas fa-stop me-1"></i> Stop
          </button>
        </div>

        <div *ngIf="faceStatus" class="alert" [ngClass]="{
          'alert-info': faceStatus.type === 'info',
          'alert-success': faceStatus.type === 'success',
          'alert-danger': faceStatus.type === 'error'
        }">
          <i class="fas" [ngClass]="{
            'fa-info-circle': faceStatus.type === 'info',
            'fa-check-circle': faceStatus.type === 'success',
            'fa-exclamation-circle': faceStatus.type === 'error'
          }"></i>
          {{ faceStatus.message }}
        </div>

        <button *ngIf="faceData" type="button" class="btn btn-primary mt-2" (click)="registerFace()" (click)="stopCamera()">
          Save Face Data
        </button>

      </div>
    </div>
  </div>
</p-dialog>
