<div class="wrapper">
  <nav id="sidebar" class="sidebar js-sidebar">
    <div class="sidebar-content js-simplebar">
      <a class="sidebar-brand" href="/home">
        <img src="assets/images/logo_BDMS.png" class="align-middle" style="height: 30px;">
      </a>
      <ul class="sidebar-nav">
        <li class="sidebar-header">Pages</li>
        <li class="sidebar-item">
          <a class="sidebar-link" href="/home">
            <i class="align-middle" data-feather="sliders"></i> <span class="align-middle">Dashboard</span>
          </a>
        </li>
        <li class="sidebar-item">
          <a class="sidebar-link" href="/users">
            <i class="align-middle" data-feather="user"></i> <span class="align-middle">Liste des utilisateurs</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="main">
    <nav class="navbar navbar-expand navbar-light navbar-bg">
      <a class="sidebar-toggle js-sidebar-toggle">
        <i class="hamburger align-self-center"></i>
      </a>

      <div class="navbar-collapse collapse">
        <ul class="navbar-nav navbar-align">
            <li class="nav-item dropdown">
                <a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown" aria-expanded="false" id="mobileDropdown">
                    <i class="align-middle" data-feather="settings"></i>
                </a>
                <a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                    <!-- Image with fallback -->
                    <img [src]="getUserImagePath() || '/assets/images/default-avatar.png'"
                         class="avatar img-fluid rounded me-1"
                         style="width: 32px; height: 32px; object-fit: cover;"
                         onerror="this.onerror=null;this.src='/assets/images/default-avatar.png'">
                    
                    <span class="text-dark" *ngIf="user">
                      {{ user.username || user.preferred_username || user.name || 'No username' }}
                    </span>
                  </a>            
                <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item" href="/profile"><i class="align-middle me-1" data-feather="user"></i> Profile</a>
                    <a class="dropdown-item" href="#" (click)="logout(); $event.preventDefault()">
                        <i class="align-middle me-1" data-feather="log-out"></i> Log out
                      </a>
                                  
                </div>
            </li>
        </ul>
    </div>
    </nav>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Face Recognition Setup</h5>
      </div>
      <div class="card-body">
        <div class="face-capture-container text-center">
          <div class="camera-frame mb-3">
            <div class="camera-overlay">
              <div class="face-guide"></div>
            </div>
            <video #videoElement width="320" height="240" autoplay muted playsinline></video>
            <canvas #canvasElement width="320" height="240" class="d-none"></canvas>
            <img #photoElement class="preview-image d-none" alt="Your face">
          </div>
          <div class="camera-controls mb-3">
            <button type="button" class="btn btn-primary me-2" (click)="startCamera()">
              <i class="fas fa-video me-1"></i> Start Camera
            </button>
            <button type="button" class="btn btn-success me-2" (click)="captureFace()" [disabled]="!isCameraOn">
              <i class="fas fa-camera me-1"></i> Capture
            </button>
            <button type="button" class="btn btn-danger" (click)="stopCamera()" [disabled]="!isCameraOn">
              <i class="fas fa-stop me-1"></i> Stop
            </button>
          </div>
    
          <div *ngIf="faceStatus" class="alert" [ngClass]="{
            'alert-info': faceStatus.type === 'info',
            'alert-success': faceStatus.type === 'success',
            'alert-danger': faceStatus.type === 'error'
          }">
            <i class="fas" [ngClass]="{
              'fa-info-circle': faceStatus.type === 'info',
              'fa-check-circle': faceStatus.type === 'success',
              'fa-exclamation-circle': faceStatus.type === 'error'
            }"></i>
            {{ faceStatus.message }}
          </div>
    
          <button *ngIf="faceData" type="button" class="btn btn-primary mt-2" (click)="registerFace()">
            Save Face Data
          </button>
    
          <button *ngIf="faceData" type="button" class="btn btn-secondary mt-2 ms-2" (click)="faceLogin()">
            Login with Face
          </button>
        </div>
      </div>
    </div>
    
    <div class="container">
      <br><br><br>
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-8">
          <div class="card">
            <div class="card-header text-center">
              <h5 class="card-title mb-0">Profile Details</h5>
            </div>
            <div class="card-body text-center">
              <!-- User image circle -->
              <div class="user-image-container mb-4">
                <div class="user-image-circle mx-auto">
                  <img [src]="getUserImagePath() || '/assets/images/default-avatar.png'"
                         class="avatar img-fluid rounded me-1"
                         style="width: 100px; height: 100px; object-fit: cover;"
                         onerror="this.onerror=null;this.src='/assets/images/default-avatar.png'">
                </div>
              </div>

              <!-- Add these near your form submit button -->
              <div *ngIf="isUpdating" class="text-center mt-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Updating profile...</span>
              </div>

              <div *ngIf="errorMessage" class="alert alert-danger mt-3">
                {{ errorMessage }}
              </div>

              <div *ngIf="successMessage" class="alert alert-success mt-3">
                {{ successMessage }}
              </div>

              <!-- Profile form -->
              <div class="profile-form-container">
                <form (ngSubmit)="updateUser()" class="text-start">
                  <div class="mb-3">
                    <label for="preferred_username" class="form-label">Username:</label>
                    <input type="text" class="form-control" id="preferred_username"
                           [(ngModel)]="user.preferred_username" name="preferred_username" required disabled>
                  </div>
                  <div class="mb-3">
                    <label for="firstName" class="form-label">First Name:</label>
                    <input type="text" class="form-control" id="firstName"
                           [(ngModel)]="user.firstName" name="firstName" required>
                  </div>
                  <div class="mb-3">
                    <label for="lastName" class="form-label">Last Name:</label>
                    <input type="text" class="form-control" id="lastName"
                           [(ngModel)]="user.lastName" name="lastName" required>
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">Email:</label>
                    <input type="email" class="form-control" id="email"
                           [(ngModel)]="user.email" name="email" required disabled>
                  </div>
                  <div class="mb-3">
                    <label for="image" class="form-label">Importer une image</label>
                    <input type="file" class="form-control" id="image" accept="image/*" (change)="onFileSelectedAjout($event)">
                  </div>
                  <div class="mb-3">
                    <label for="adresse" class="form-label">Address:</label>
                    <input type="text" class="form-control" id="adresse"
                           [(ngModel)]="user.adresse" name="adresse">
                  </div>
                  <div class="mb-3">
                    <label for="phone" class="form-label">Phone:</label>
                    <input type="text" class="form-control" id="phone"
                           [(ngModel)]="user.phone" name="phone">
                  </div>
                  <div class="text-center">
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
